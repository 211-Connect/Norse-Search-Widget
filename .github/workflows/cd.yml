name: CD

on:
  push:
    tags:
      - "v*"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "yarn"

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Type check
        run: yarn type-check

      - name: Build
        run: yarn build

      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Install s3cmd
        run: |
          sudo apt-get update
          sudo apt-get install -y s3cmd

      - name: Configure s3cmd for DigitalOcean Spaces
        run: |
          cat > ~/.s3cfg << EOF
          [default]
          access_key = ${{ secrets.DO_SPACES_ACCESS_KEY }}
          secret_key = ${{ secrets.DO_SPACES_SECRET_KEY }}
          host_base = sfo3.digitaloceanspaces.com
          host_bucket = %(bucket)s.sfo3.digitaloceanspaces.com
          use_https = True
          signature_v2 = False
          EOF

      - name: Upload to version-specific folder
        run: |
          s3cmd sync --acl-public --no-mime-magic --guess-mime-type \
            --add-header="Cache-Control:public, max-age=31536000, immutable" \
            dist/widget/ s3://search-widget-c211/${{ steps.get_version.outputs.VERSION }}/

      - name: Upload to latest folder
        run: |
          s3cmd sync --acl-public --no-mime-magic --guess-mime-type \
            --add-header="Cache-Control:public, max-age=3600" \
            --delete-removed \
            dist/widget/ s3://search-widget-c211/latest/

      - name: Print CDN URLs
        run: |
          echo "ðŸš€ Deployment successful!"
          echo ""
          echo "Version ${{ steps.get_version.outputs.VERSION }} URLs:"
          echo "  UMD: https://search-widget-c211.sfo3.cdn.digitaloceanspaces.com/${{ steps.get_version.outputs.VERSION }}/search-widget.umd.js"
          echo "  ESM: https://search-widget-c211.sfo3.cdn.digitaloceanspaces.com/${{ steps.get_version.outputs.VERSION }}/search-widget.es.js"
          echo "  CSS: https://search-widget-c211.sfo3.cdn.digitaloceanspaces.com/${{ steps.get_version.outputs.VERSION }}/search-widget.css"
          echo ""
          echo "Latest URLs:"
          echo "  UMD: https://search-widget-c211.sfo3.cdn.digitaloceanspaces.com/latest/search-widget.umd.js"
          echo "  ESM: https://search-widget-c211.sfo3.cdn.digitaloceanspaces.com/latest/search-widget.es.js"
          echo "  CSS: https://search-widget-c211.sfo3.cdn.digitaloceanspaces.com/latest/search-widget.css"
